# Тестовое задание. Backend, Python

Необходимо реализовать асинхронное веб приложение в парадигме REST API.

Необходимо реализовать работу со следующими сущностями:
1. Пользователь  
2. Администратор  
3. Счет - имеет баланс, привязан к пользователю  
4. Платеж(пополнение баланса) - хранит уникальный идентификатор и сумму пополнения счета пользователя  

Пользователь должен иметь следующие возможности:
- Авторизоваться по email/password  
- Получить данные о себе(id, email, fullname)  
- Получить список своих счетов и балансов  
- Получить список своих платежей  

Администратор должен иметь следующие возможности:
- Авторизоваться по email/password  
- Получить данные о себе (id, email, fullname)  
- Создать/Удалить/Обновить пользователя  
- Получить список пользователей и список его счетов с балансами  

Для работы с платежами должен быть реализован роут эмулирующий обработку вебхука от сторонней платежной системы. Структура json-объекта для обработки вебхука должна состоять из следующих полей:  
transaction_id - уникальный идентификатор транзакции в “сторонней системе”  
account_id - уникальный идентификатор счета пользователя  
user_id - уникальный идентификатор счета пользователя  
amount - сумма пополнения счета пользователя  
signature - подпись объекта  

signature должна формироваться через SHA256 хеш, для строки состоящей из конкатенации значений объекта в алфавитном порядке ключей и “секретного ключа” хранящегося в конфигурации проекта ({account_id}{amount}{transaction_id}{user_id}{secret_key}). 

Пример, для secret_key gfdmhghif38yrf9ew0jkf32:  
{  
  "transaction_id": "5eae174f-7cd0-472c-bd36-35660f00132b",  
  "user_id": 1,  
  "account_id": 1,  
  "amount": 100,  
  "signature": "7b47e41efe564a062029da3367bde8844bea0fb049f894687cee5d57f2858bc8"  
}

При обработке вебхука необходимо:
1. Проверить подпись объекта  
2. Проверить существует ли у пользователя такой счет - если нет, его необходимо создать  
3. Сохранить транзакцию в базе данных  
4. Начислить сумму транзакции на счет пользователя  

Транзакции являются уникальными, начисление суммы с одним transaction_id должно производиться только один раз.

Для тестирования приложения в миграции должен быть создан:
- Тестовый пользователь  
- Счет тестового пользователя  
- Тестовый администратор  

## Сборка приложения
1. Клонировать репозиторий и перейти в корень приложения
2. Запустить сборку образа приложения:  
`docker build -t sanic_web_api .`  
3. Запустить контейнеры БД и приложения (веб-сервер)  
`docker compose up -d`

## REST API
Swagger UI http://localhost:8000/docs/swagger  

## Тестирование
В папке tests лежит файл для импорта в Postman (или аналоги)  
`tests\sanic_web_api.postman_collection.json`

После импорта будет доступна возможность запустить API тесты

## TODO
Очистка кеша Redis  
Фабрика сессий async_scoped_session  
Частичное обновление UpdatePartial (обработка PATH-запросов)  
Вынесение CRUD из API моделей (рефакторинг)  